<!doctype html>
<!--

 This page was compiled by ðŸ“œ Scroll, a public domain
 programming language and static site publishing tool.
 
 https://scroll.pub
 
 Generally you don't want to edit it by hand.

 Scroll v31.4.1

-->
<html lang="en-US">
 <head>
  <meta charset="utf-8"></meta>
  <title>Running a Windows VM on KubeVirt on K3s - Cookies & Containers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"></meta>
  <meta name="description" content="Or how I learned to love the cloud."></meta>
  <meta name="generator" content="Scroll v31.4.1"></meta>
  <meta property="og:title" content="Running a Windows VM on KubeVirt on K3s"></meta>
  <meta property="og:description" content="November 3, 2020 â€” To get the obvious "WTF, why would you wanna do this?" out of the way: We had to. For reasons."></meta>
  <meta property="og:image" content="https://charlottemach.com/assets/images/windows.png "Windows VM""></meta>
  <link rel="alternate" type="application/rss+xml" title="Cookies & Containers" href="feed.xml"></link>
  <meta name="twitter:card" content="summary_large_image"></meta>
  <link rel="stylesheet" type="text/css" href="scrollStyle.css"></link>
</head>
 <body>
  <div class="scrollHeaderComponent">
   <div class="scrollTopRightBarComponent">
    <div class="scrollSocialMediaIconsComponent">
     <a href="https://github.com/charlottemach/"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
</div>
</div>
   <h2 class="scrollNameComponent">
    <a href="index.html">Cookies & Containers</a>
</h2>
   <div>Or how I learned to love the cloud.</div>
</div>
  <h1 class="scrollFilePageTitle">
   <a href="2020-11-03-windows-kubevirt-k3s.html">Running a Windows VM on KubeVirt on K3s</a>
</h1>
  <div class="scrollFilePageComponent" style=""><h1 class="scrollTitleComponent"><a href="2020-11-03-windows-kubevirt-k3s.html">Running a Windows VM on KubeVirt on K3s</a></h1>























<div class="scrollKeyboardNav"><a href="2021-03-17-quick-openstack.html">2021-03-17-quick-openstack.html</a> Â· 2020-11-03-windows-kubevirt-k3s.html Â· <a href="2020-08-31-simple-k8s-operator-java.html">2020-08-31-simple-k8s-operator-java.html</a><script>document.addEventListener('keydown', function(event) {
  if (document.activeElement !== document.body) return
  const getLinks = () => document.getElementsByClassName("scrollKeyboardNav")[0].getElementsByTagName("a")
  if (event.key === "ArrowLeft")
    getLinks()[0].click()
  else if (event.key === "ArrowRight")
    getLinks()[1].click()
 });</script></div>

<p class="scrollParagraphComponent"><span class="scrollDateComponent">November 3, 2020 â€” </span>To get the obvious "WTF, why would you wanna do this?" out of the way: We had to. For reasons.</p>

<h3 class="scrollSectionComponent">Reasons</h3>

<p>In cases where you need a Windows VM, but don&#39;t want to leave your Kubernetes platform, <a href="https://kubevirt.io/">KubeVirt</a> is your friend.</p>

<p class="scrollParagraphComponent">Be warned that this is going to be a heavy workload, so go for something with a lot of CPU, memory and disk space.</p>



<h3 class="scrollSectionComponent">Install</h3>

<p class="scrollParagraphComponent">Let's start with installing K3s and KubeVirt on an Ubuntu 20.10 instance.</p>

<ul>
<li>Install K3s (<a href=https://rancher.com/docs/k3s/latest/en/installation/install-options/>docs</a>).</li>
</ul>

<code class="scrollCodeBlockComponent">apt update && apt -y upgrade
curl -sfL https://get.k3s.io | sh -</code>

<p class="scrollParagraphComponent">Check if the install succeeded, e.g. by creating a deployment and seeing if pods are running.</p>
<ul>
<li>Install KubeVirt (<a href=https://kubevirt.io/quickstart_minikube/>docs</a>). I used the operator, but any of those should do the trick.</li>
</ul>

<code class="scrollCodeBlockComponent">export VERSION=$(curl -s https://api.github.com/repos/kubevirt/kubevirt/releases | grep tag_name | grep -v -- '-rc' | head -1 | awk -F': ' '{print $2}' | sed 's/,//' | xargs)

echo $VERSION
kubectl create -f https://github.com/kubevirt/kubevirt/releases/download/${VERSION}/kubevirt-operator.yaml
kubectl create -f https://github.com/kubevirt/kubevirt/releases/download/${VERSION}/kubevirt-cr.yaml
   </code>
<p class="scrollParagraphComponent">Check if the install succeeded with</p>
<code class="scrollCodeBlockComponent">kubectl get kubevirt.kubevirt.io/kubevirt -n kubevirt -o=jsonpath="{.status.phase}"
kubectl get all -n kubevirt</code>

<ul>
<li>Install virtctl to control KubeVirt VMs. I used the Kubernetes plugin manager <a href="https://krew.sigs.k8s.io/">Krew</a>.</li>
</ul>

<code class="scrollCodeBlockComponent">apt-get install git
(   set -x; cd "$(mktemp -d)" &&   curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/krew.tar.gz" &&   tar zxvf krew.tar.gz &&   KREW=./krew-"$(uname | tr '[:upper:]' '[:lower:]')_$(uname -m | sed -e 's/x86_64/amd64/' -e 's/arm.*$/arm/')" &&   "$KREW" install krew; )

export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
kubectl krew install virt</code>

<ul>
<li>Install <a href="https://github.com/kubevirt/containerized-data-importer/blob/master/README.md">Containerized-Data-Importer (CDI)</a> to manage your VM disk later on. I used the operator version.</li>
</ul>


<code class="scrollCodeBlockComponent">export VERSION=$(curl -s https://github.com/kubevirt/containerized-data-importer/releases/latest | grep -o "v[0-9]\.[0-9]*\.[0-9]*")
kubectl create -f https://github.com/kubevirt/containerized-data-importer/releases/download/$VERSION/cdi-operator.yaml
kubectl create -f https://github.com/kubevirt/containerized-data-importer/releases/download/$VERSION/cdi-cr.yaml</code>

<h3 class="scrollSectionComponent">Add Windows</h3>
<ul>
<li>Download a Windows ISO file (the <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019">Microsoft Evaluation Center</a> lets you trial a Windows ISO for 180 days).</li>
<li>Upload the ISO.</li>
</ul>

<code class="scrollCodeBlockComponent"># Get the CDI upload proxy service IP:
kubectl get svc -n cdi
   
# Upload 
kubectl virt image-upload --image-path &lt;/path/to/iso> \
  --pvc-name iso-win2k19 --access-mode ReadWriteOnce \
  --pvc-size 10G --uploadproxy-url &lt;upload-proxy service:443> \
  --insecure --wait-secs=240</code>
<p>More info on the upload command can be found <a href="https://kubevirt.io/2019/How-To-Import-VM-into-Kubevirt.html">here</a>. I had to change the access mode of the PVC to ReadWriteOnce, as the default local-path storageclass of K3s doesn&#39;t support any other modes at this point. Since we&#39;re only using one node this doesn&#39;t make a difference, but will be an issue for larger K3s clusters.
  </p>

<ul>
<li>Use containerd to pull the virtio-container-disk image containing the drivers. If you&#39;re using Docker, change the command to pull via docker.</li>
</ul>

<code class="scrollCodeBlockComponent">ctr image pull kubevirt/virtio-container-disk</code>

<h3 class="scrollSectionComponent">Create the VM</h3>
<ul>
<li>Create a YAML file with a PVC and a VM.</li>
</ul>

<code class="scrollCodeBlockComponent">---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: winhd
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 15Gi
  storageClassName: hostpath</code>
<code class="scrollCodeBlockComponent">---
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachine
metadata:
  name: win2k19-iso
spec:
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/domain: win2k19-iso
    spec:
      domain:
        cpu:
          cores: 4
        devices:
          disks:
          - bootOrder: 1
            cdrom:
              bus: sata
            name: cdromiso
          - disk:
              bus: virtio
            name: harddrive
          - cdrom:
              bus: sata
            name: virtiocontainerdisk
        machine:
          type: q35
        resources:
          requests:
            memory: 8G
      volumes:
      - name: cdromiso
        persistentVolumeClaim:
          claimName: iso-win2k19
      - name: harddrive
        persistentVolumeClaim:
          claimName: winhd
      - containerDisk:
          image: kubevirt/virtio-container-disk
        name: virtiocontainerdisk</code>
<ul>
<li>Create and use the VM.</li>
</ul>

<code class="scrollCodeBlockComponent">kubectl apply -f win2k19.yaml
kubectl virt start win2k19-iso
# If you're running this on a remote machine, use X-forwarding and
# apt-get install virt-viewer
kubectl virt vnc win2k19-iso</code>
<ul>
<li>Walk through the Windows install to get a running Windows VM.</li>
</ul>

<figure class="scrollImageComponent"><a href="assets/images/windows.png" target="_blank"><img src="assets/images/windows.png" width="2880" height="1800" loading="lazy"/></a></figure>
<h4 class="scrollSubsectionComponent">Note</h4>
<p>If your drivers didn&#39;t install successfully and your Network connection isn&#39;t working because of that, you need to go into the Device Manager on Windows, click on the OtherDevices and update the driver from your local drive where virtio has stored it&#39;s files. In my case it was <code>E:\</code>.</p>

<ul>
<li>Final step is to add a service to allow for RDP connections.</li>
</ul>

<code class="scrollCodeBlockComponent">apiVersion: v1
kind: Service
metadata:
  name: windows-nodeport
spec:
  externalTrafficPolicy: Cluster
  ports:
  - name: nodeport
    nodePort: 30000
    port: 27017
    protocol: TCP
    targetPort: 3389
  selector:
    kubevirt.io/domain: win2k19-iso
  type: NodePort</code>
<p>Which then allows you to access your Windows VM via RDP on <code>&lt;NodeIp&gt;:30000</code>.</p>

<h3 class="scrollSectionComponent">Further reading</h3>

<ol>
<li>Adapted to K3s from <a href="https://kubevirt.io/2020/KubeVirt-installing_Microsoft_Windows_from_an_iso.html">https://kubevirt.io/2020/KubeVirt-installing_Microsoft_Windows_from_an_iso.html</a></li>
</ol>



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', 'UA-182099903-1', 'auto');ga('send', 'pageview');</script>
<p class="scrollFileViewSourceUrlComponent"><a href="https://github.com/charlottemach/charlottemach.github.io/blob/main/2020-11-03-windows-kubevirt-k3s.scroll">View source</a></p></div>
  <div class="scrollFooterComponent">
   <div class="scrollSocialMediaIconsComponent">
    <a href="mailto:charlotte.mach@fs.lmu.de"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Gmail icon</title><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg></a>
    <a href="https://twitter.com/tinydata42"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Twitter icon</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg></a>
    <a href="https://github.com/charlottemach/"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
</div>
   <a href="https://scroll.pub" class="scrollCommunityLinkComponent">Built with Scroll v31.4.1</a>
</div>
</body>
</html>
