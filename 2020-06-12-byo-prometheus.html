<!doctype html>
<!--

 This page was compiled by ðŸ“œ Scroll, a public domain
 programming language and static site publishing tool.
 
 https://scroll.pub
 
 Generally you don't want to edit it by hand.

 Scroll v31.4.1

-->
<html lang="en-US">
 <head>
  <meta charset="utf-8"></meta>
  <title>Bring Your Own Prometheus to Istio - Cookies & Containers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"></meta>
  <meta name="description" content="Or how I learned to love the cloud."></meta>
  <meta name="generator" content="Scroll v31.4.1"></meta>
  <meta property="og:title" content="Bring Your Own Prometheus to Istio"></meta>
  <meta property="og:description" content="June 12, 2020 â€” How to integrate your standalone Prometheus with Istio-enabled Pods as mentioned briefly in the  Istio docs here."></meta>
  <meta property="og:image" content=""></meta>
  <link rel="alternate" type="application/rss+xml" title="Cookies & Containers" href="feed.xml"></link>
  <meta name="twitter:card" content="summary_large_image"></meta>
  <link rel="stylesheet" type="text/css" href="scrollStyle.css"></link>
</head>
 <body>
  <div class="scrollHeaderComponent">
   <div class="scrollTopRightBarComponent">
    <div class="scrollSocialMediaIconsComponent">
     <a href="https://github.com/charlottemach/"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
</div>
</div>
   <h2 class="scrollNameComponent">
    <a href="index.html">Cookies & Containers</a>
</h2>
   <div>Or how I learned to love the cloud.</div>
</div>
  <h1 class="scrollFilePageTitle">
   <a href="2020-06-12-byo-prometheus.html">Bring Your Own Prometheus to Istio</a>
</h1>
  <div class="scrollFilePageComponent" style=""><h1 class="scrollTitleComponent"><a href="2020-06-12-byo-prometheus.html">Bring Your Own Prometheus to Istio</a></h1>


<p class="scrollParagraphComponent"><span class="scrollDateComponent">June 12, 2020 â€” </span>How to integrate your standalone Prometheus with Istio-enabled Pods as mentioned briefly in the <a href="https://istio.io/blog/2020/proxy-cert/"> Istio docs here.</a></p>














<div class="scrollKeyboardNav"><a href="2020-06-25-adventures-telco-xos.html">2020-06-25-adventures-telco-xos.html</a> Â· 2020-06-12-byo-prometheus.html Â· <a href="2020-05-17-co2-sensor-raspi.html">2020-05-17-co2-sensor-raspi.html</a><script>document.addEventListener('keydown', function(event) {
  if (document.activeElement !== document.body) return
  const getLinks = () => document.getElementsByClassName("scrollKeyboardNav")[0].getElementsByTagName("a")
  if (event.key === "ArrowLeft")
    getLinks()[0].click()
  else if (event.key === "ArrowRight")
    getLinks()[1].click()
 });</script></div>

<p class="scrollParagraphComponent">Istio 1.5 comes with a new control plane architecture, but still allows for the easy enabling of Kiali, Prometheus, Grafana and so on. Those built-in components are not production-ready and usually only used for monitoring istio-system components.</p>

<p class="scrollParagraphComponent">If you want to set up your own Prometheus in a separate namespace, you need a way to collect metrics from Istio-enabled Pods. The easy version is to set your <b>global mTLS</b> to <b>PERMISSIVE</b>, allowing both encrypted and unencrypted traffic between your application and system Pods. Prometheus will then simply get Pod metrics without encrypting the requests.</p>

<p class="scrollParagraphComponent">This approach isnâ€™t ideal for a few reasons, so this blog shows how to encrypt the scrape jobs with certificates requested from Istio itself.
The idea is simple, add a sidecar to Prometheus that requests certificated from Istio and then doesn't catch and encrypt all traffic for you, but instead let's the Prometheus Pod use the certificates to encrypt the scrape requests itself.</p>

<h3 class="scrollSectionComponent">Custom Sidecar</h3>

<p class="scrollParagraphComponent">If your Prometheus is in an istio-injection:enabled namespace, turn off the automatic sidecar injection by adding</p>
<code class="scrollCodeBlockComponent">   template:
     metadata:
       annotations:
         sidecar.istio.io/inject: "false"</code>
<p class="scrollParagraphComponent">to the prometheus Pod deployment spec.</p>

<p class="scrollParagraphComponent">Manually add a an istio-proxy sidecar to your Prometheus Pod.</p>
<code class="scrollCodeBlockComponent">     - name: istio-proxy
       image: docker.io/istio/proxyv2:1.5.1
       imagePullPolicy: IfNotPresent
       args:
       - proxy
       - sidecar
       - --domain
       - $(POD_NAMESPACE).svc.cluster.local
       - --configPath
       - /etc/istio/proxy
       - --binaryPath
       - /usr/local/bin/envoy
       - --serviceCluster
       - istio-proxy-prometheus
       - --drainDuration
       - 45s
       - --parentShutdownDuration
       - 1m0s
       - --discoveryAddress
       - istio-pilot.istio-system.svc:15012
       - --proxyLogLevel=warning
       - --proxyComponentLogLevel=misc:error
       - --connectTimeout
       - 10s
       - --proxyAdminPort
       - "15000"
       - --controlPlaneAuthPolicy
       - NONE
       - --dnsRefreshRate
       - 300s
       - --statusPort
       - "15020"
       - --trust-domain=cluster.local
       - --controlPlaneBootstrap=false
       env:
       - name: OUTPUT_CERTS
         value: /etc/istio-certs
       - name: JWT_POLICY
         value: third-party-jwt
       - name: PILOT_CERT_PROVIDER
         value: istiod
       - name: CA_ADDR
         value: istio-pilot.istio-system.svc:15012
       - name: POD_NAME
         valueFrom:
           fieldRef:
             fieldPath: metadata.name
       - name: POD_NAMESPACE
         valueFrom:
           fieldRef:
             fieldPath: metadata.namespace
       - name: INSTANCE_IP
         valueFrom:
           fieldRef:
             fieldPath: status.podIP
       - name: SERVICE_ACCOUNT
         valueFrom:
           fieldRef:
             fieldPath: spec.serviceAccountName
       - name: HOST_IP
         valueFrom:
           fieldRef:
             fieldPath: status.hostIP
       - name: ISTIO_META_POD_NAME
         valueFrom:
           fieldRef:
             fieldPath: metadata.name
       - name: ISTIO_META_CONFIG_NAMESPACE
         valueFrom:
           fieldRef:
             fieldPath: metadata.namespace
       - name: ISTIO_META_MESH_ID
         value: cluster.local
       - name: ISTIO_META_CLUSTER_ID
         value: Kubernetes
       ports:
       - containerPort: 15090
         name: http-envoy-prom
         protocol: TCP
       readinessProbe:
         failureThreshold: 30
         httpGet:
           path: /healthz/ready
           port: 15020
           scheme: HTTP
         initialDelaySeconds: 1
         periodSeconds: 2
         successThreshold: 1
         timeoutSeconds: 1
       volumeMounts:
       - mountPath: /var/run/secrets/istio
         name: istiod-ca-cert
       - mountPath: /etc/istio/proxy
         name: istio-envoy
       - mountPath: /var/run/secrets/tokens
         name: istio-token
       - mountPath: /etc/istio-certs/
         name: istio-certs</code>
<p class="scrollParagraphComponent">Add the following volumes to your Pod</p>
<code class="scrollCodeBlockComponent">     - name: istio-cert
       emptyDir:
         medium: Memory
     - name: istio-envoy
       emptyDir:
         medium: Memory
     - name: istio-token
       projected:
         defaultMode: 420
         sources:
         - serviceAccountToken:
             audience: istio-ca
             expirationSeconds: 43200
             path: istio-token
     - name: istiod-ca-cert
       configMap:
         defaultMode: 420
         name: istio-ca-root-cert</code>
<p class="scrollParagraphComponent">Add scrape rule for Istio Pods (usually in the Prometheus configmap):</p>
<code class="scrollCodeBlockComponent">- job_name: 'kubernetes-pods-istio-secure'
  scheme: https
  tls_config:
    ca_file: /etc/istio-certs/root-cert.pem
    cert_file: /etc/istio-certs/cert-chain.pem
    key_file: /etc/istio-certs/key.pem
    insecure_skip_verify: true  # Prometheus does not support secure naming.
  kubernetes_sd_configs:
  - role: pod
  relabel_configs:
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
    action: keep
    regex: true
  # sidecar status annotation is added by sidecar injector and
  # istio_workload_mtls_ability can be specifically placed on a Pod to indicate its ability to receive mtls traffic.
  - source_labels: [__meta_kubernetes_pod_annotation_sidecar_istio_io_status, __meta_kubernetes_pod_annotation_istio_mtls]
    action: keep
    regex: (([^;]+);([^;]*))|(([^;]*);(true))
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
    action: replace
    target_label: __metrics_path__
    regex: (.+)
  - source_labels: [__address__]  # Only keep address that is host:port
    action: keep    # otherwise an extra target with ':443' is added for https scheme
    regex: ([^:]+):(\d+)
  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
    action: replace
    regex: ([^:]+)(?::\d+)?;(\d+)
    replacement: $1:$2
    target_label: __address__
  - action: labelmap
    regex: __meta_kubernetes_pod_label_(.+)
  - source_labels: [__meta_kubernetes_namespace]
    action: replace
    target_label: namespace</code>

<p class="scrollParagraphComponent">The manually injected sidecar will request a certificate and key from istiod and save those into /etc/istio-certs/ and this part </p>
<code class="scrollCodeBlockComponent"> tls_config:
   ca_file: /etc/istio-certs/root-cert.pem
   cert_file: /etc/istio-certs/cert-chain.pem
   key_file: /etc/istio-certs/key.pem
   insecure_skip_verify: true</code>
<p class="scrollParagraphComponent">from step 3 will then be used to configure TLS for the scrape requests.</p>
<p class="scrollParagraphComponent">Now you should have your own Prometheus scraping metrics with encrypted traffic.</p>

<h3 class="scrollSectionComponent">Future</h3>
<p class="scrollParagraphComponent">If the Prometheus or Istio version change, check out the Prometheus that comes with Istio and how the sidecar of that instance requests certificates and uses them. </p>
<p class="scrollFileViewSourceUrlComponent"><a href="https://github.com/charlottemach/charlottemach.github.io/blob/main/2020-06-12-byo-prometheus.scroll">View source</a></p></div>
  <div class="scrollFooterComponent">
   <div class="scrollSocialMediaIconsComponent">
    <a href="mailto:charlotte.mach@fs.lmu.de"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Gmail icon</title><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg></a>
    <a href="https://twitter.com/tinydata42"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Twitter icon</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg></a>
    <a href="https://github.com/charlottemach/"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
</div>
   <a href="https://scroll.pub" class="scrollCommunityLinkComponent">Built with Scroll v31.4.1</a>
</div>
</body>
</html>
