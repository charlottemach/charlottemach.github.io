<!doctype html>
<!--

 This page was compiled by ðŸ“œ Scroll, a public domain
 programming language and static site publishing tool.
 
 https://scroll.pub
 
 Generally you don't want to edit it by hand.

 Scroll v31.4.1

-->
<html lang="en-US">
 <head>
  <meta charset="utf-8"></meta>
  <title>Containerizing a simple Flask App - Cookies & Containers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"></meta>
  <meta name="description" content="Or how I learned to love the cloud."></meta>
  <meta name="generator" content="Scroll v31.4.1"></meta>
  <meta property="og:title" content="Containerizing a simple Flask App"></meta>
  <meta property="og:description" content="November 29, 2021 â€” It never hurts to have a basic example for a quick WebApp to deploy onto a container service. Here's one for a Python app, using Flask, Docker and Gunicorn."></meta>
  <meta property="og:image" content="https://charlottemach.com/assets/images/flaskapp-safari.png WebApp"></meta>
  <link rel="alternate" type="application/rss+xml" title="Cookies & Containers" href="feed.xml"></link>
  <meta name="twitter:card" content="summary_large_image"></meta>
  <link rel="stylesheet" type="text/css" href="scrollStyle.css"></link>
</head>
 <body>
  <div class="scrollHeaderComponent">
   <div class="scrollTopRightBarComponent">
    <div class="scrollSocialMediaIconsComponent">
     <a href="https://github.com/charlottemach/"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
</div>
</div>
   <h2 class="scrollNameComponent">
    <a href="index.html">Cookies & Containers</a>
</h2>
   <div>Or how I learned to love the cloud.</div>
</div>
  <h1 class="scrollFilePageTitle">
   <a href="2021-11-29-simple-flask-docker-app.html">Containerizing a simple Flask App</a>
</h1>
  <div class="scrollFilePageComponent" style=""><h1 class="scrollTitleComponent"><a href="2021-11-29-simple-flask-docker-app.html">Containerizing a simple Flask App</a></h1>




















<div class="scrollKeyboardNav"><a href="2021-12-16-lambda-s3-dynamo.html">2021-12-16-lambda-s3-dynamo.html</a> Â· 2021-11-29-simple-flask-docker-app.html Â· <a href="2021-11-17-syslog-fluentd.html">2021-11-17-syslog-fluentd.html</a><script>document.addEventListener('keydown', function(event) {
  if (document.activeElement !== document.body) return
  const getLinks = () => document.getElementsByClassName("scrollKeyboardNav")[0].getElementsByTagName("a")
  if (event.key === "ArrowLeft")
    getLinks()[0].click()
  else if (event.key === "ArrowRight")
    getLinks()[1].click()
 });</script></div>

<p class="scrollParagraphComponent"><span class="scrollDateComponent">November 29, 2021 â€” </span>It never hurts to have a basic example for a quick WebApp to deploy onto a container service. Here's one for a Python app, using Flask, Docker and Gunicorn.</p>

<h3 class="scrollSectionComponent">Folder structure</h3>
<p class="scrollParagraphComponent">To get started we create the following structure (it's ok to leave the files empty, we'll fill them during the next few instructions):</p>
<code class="scrollCodeBlockComponent">.
â”œâ”€â”€ Dockerfile                   #Â Instruction for building the docker image
â”œâ”€â”€ app
â”‚Â Â  â”œâ”€â”€ app.py                   # Actual python source
â”‚Â Â  â”œâ”€â”€ templates                 
â”‚Â Â  â”‚Â Â  â””â”€â”€ factorial-form.html  # Template for HTML used in the WebApp
â”‚Â Â  â””â”€â”€ tests
â”‚Â Â      â”œâ”€â”€ __init__.py
â”‚Â Â      â””â”€â”€ test_app.py          # Simple tests for the webapp
â””â”€â”€ requirements.txt             # Required packages</code>

<p class="scrollParagraphComponent">After this we can get started with the Python code.</p>

<h3 class="scrollSectionComponent">Writing the Flask app</h3>

If you've never used Flask before, checkout the [docs](https://flask.palletsprojects.com/en/2.0.x/). It's a micro web framework, making it super easy to build a WebApp.

Our `app.py` will look like this:
<code class="scrollCodeBlockComponent">"""Main flask module."""
import math
from flask import Flask, render_template, request

app = Flask(__name__)


@app.route('/')
def factorial_form():
    """Renders main input page."""
    return render_template('factorial-form.html')

@app.route('/', methods=['POST'])
def form_post():
    """Calculates and returns factorial of input."""
    inp = int(request.form['Factorial'])
    fac = math.factorial(inp)
    return f"The factorial of {inp} is {fac}."


if __name__ == '__main__':
    app.run()</code>
<p class="scrollParagraphComponent">The first function creates the main page from the template file</p>
<code class="scrollCodeBlockComponent">&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;head>
    &lt;meta charset="UTF-8">
    &lt;title>FactorialApp&lt;/title>
&lt;/head>
&lt;body>
    &lt;h1>Calculate factorials&lt;/h1>
    &lt;h4>Enter a number:&lt;h4>
    &lt;form method="POST">
        &lt;input type="number" name="Factorial" min="0" required>
        &lt;input type="submit" value="Calculate">
    &lt;/form>
&lt;/body>
&lt;/html></code>
<p class="scrollParagraphComponent">which is basically just a form taking a single number as an input.</p>
The second function of `app.py` receives the input from the POST request, calculates the [factorial](https://en.wikipedia.org/wiki/Factorial), the product of all positive integers less than or equal to the input. E.g. the factorial of 5 would be 5*4*3*2*1=120.

The calculated number is then returned as part of a string, to create the output page.

To test this code you can simply run
<code class="scrollCodeBlockComponent">flask run</code>
and then you can see the App running on [http://127.0.0.1:5000/](http://127.0.0.1:5000/).

<h3 class="scrollSectionComponent">Testing </h3>
We use [pytest](https://docs.pytest.org/en/6.2.x/index.html) for testing, and add a few simple unit tests.
<code class="scrollCodeBlockComponent">import app
import json
import pytest

@pytest.fixture
def client():
    client = app.app.test_client()
    return client

def test_home_page(client):
    """
    GIVEN an app configured for testing
    WHEN the '/' page is requested (GET)
    THEN check response is valid and correct
    """
    response = client.get('/')
    assert response.status_code == 200
    assert b"Enter a number:" in response.data

def test_home_page_post(client):
    """
    GIVEN an app configured for testing
    WHEN the '/' page is is posted to without num (POST)
    THEN check that an error is returned
    """
    response = client.post('/')
    print(response.data)
    assert response.status_code == 400
    assert b"The factorial of" not in response.data

def test_home_page_post_number(client):
    """
    GIVEN an app configured for testing
    WHEN the '/' page is is posted to with a number (POST)
    THEN check that its factorial is returned
    """
    headers={'Content-Type': 'application/x-www-form-urlencoded'}
    response = client.post(
                '/',
                data="Factorial=5",
                headers=headers,
            )
    assert response.data == b"The factorial of 5 is 120."</code>
<p class="scrollParagraphComponent">First we need a fixture to create the client to run the tests against (think of it like an instance of your app).
Then we try to see if the webpage is up and contains some of the HTML of the template.</p>
<p class="scrollParagraphComponent">The second test simply checks if a false POST receives the error we want (no input, no result).</p>
<p class="scrollParagraphComponent">The third test checks if the calculation returns the expected result for a specific input. </p>

<p class="scrollParagraphComponent">To run the tests</p>
<code class="scrollCodeBlockComponent">pytest -v</code>
<p class="scrollParagraphComponent">and you should receive an output like</p>
<code class="scrollCodeBlockComponent">============================================ test session starts ============================================
platform darwin -- Python 3.9.9, pytest-6.2.5, py-1.11.0, pluggy-1.0.0 -- /usr/local/opt/python@3.9/bin/python3.9
cachedir: .pytest_cache
rootdir: /Path/To/App
plugins: dash-2.0.0
collected 3 items

tests/test_app.py::test_home_page PASSED                                                              [ 33%]
tests/test_app.py::test_home_page_post PASSED                                                         [ 66%]
tests/test_app.py::test_home_page_post_number PASSED                                                  [100%]

============================================= 3 passed in 0.04s =============================================</code>

<h3 class="scrollSectionComponent">Dockerize</h3>

<p class="scrollParagraphComponent">After finishing our app, we can get started on creating the Dockerfile.</p>

<code class="scrollCodeBlockComponent"># base image to build
FROM python:3.7 as builder
RUN mkdir /install
WORKDIR /install
COPY requirements.txt /requirements.txt
RUN pip install -r /requirements.txt --target=/install

# smaller image to run
FROM python:3.7-alpine
COPY --from=builder /install /usr/local
COPY app /app
WORKDIR /app
ENV PYTHONPATH="${PYTHONPATH}:/usr/local"
EXPOSE 5000
CMD ["gunicorn", "-w 4", "-b 0.0.0.0:5000", "app:app"]</code>
<p class="scrollParagraphComponent">The first image create is the builder image, where we later copy our necessary python packages from.
This is a multi-stage Dockerfile, so you'll end up with a smaller image in the end.
We're using gunicorn as a production server for Python.</p>
<p class="scrollParagraphComponent">Then you simply build and run it</p>
<code class="scrollCodeBlockComponent">docker build -t factorialWebApp:v0.1 .
docker run -it -p 5000:5000 factorialWebApp:v0.1</code>
And your WebApp in now running on [http://127.0.0.1:5000](http://127.0.0.1:5000)!
<figure class="scrollImageComponent"><a href="assets/images/flaskapp-safari.png" target="_blank"><img src="assets/images/flaskapp-safari.png" width="1314" height="896" loading="lazy"/></a></figure>
<p class="scrollFileViewSourceUrlComponent"><a href="https://github.com/charlottemach/charlottemach.github.io/blob/main/2021-11-29-simple-flask-docker-app.scroll">View source</a></p></div>
  <div class="scrollFooterComponent">
   <div class="scrollSocialMediaIconsComponent">
    <a href="mailto:charlotte.mach@fs.lmu.de"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Gmail icon</title><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg></a>
    <a href="https://twitter.com/tinydata42"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Twitter icon</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg></a>
    <a href="https://github.com/charlottemach/"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
</div>
   <a href="https://scroll.pub" class="scrollCommunityLinkComponent">Built with Scroll v31.4.1</a>
</div>
</body>
</html>
